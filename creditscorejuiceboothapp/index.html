<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Credit Score Challenge</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            margin: 0;
            background-color: #e6f6da;
            position: relative;
            color: #111827;
        }

        /* body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url('img/grass.png');
            background-size: 220px;
            opacity: .35; 
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, .85) 0%, rgba(255, 255, 255, .45) 35%, rgba(234, 247, 218, .85) 100%);
            z-index: -1;
        } */

        /* Buttons & container */
        .answer-options {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(1fr));
            text-align: center;
        }

        .color-button {
            --swatch: #22c55e;
            --swatch-soft: #38d16b;
            display: flex;
            flex-direction: column;
            gap: .2rem;
            padding: 1.1rem 1.25rem;
            border-radius: 1.25rem;
            border: 2px solid transparent;
            background: linear-gradient(130deg, var(--swatch-soft), var(--swatch));
            color: #fff;
            font-weight: 700;
            box-shadow: 0 25px 35px -28px rgba(15, 23, 42, .9);
            transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, opacity .2s ease;
            text-align: left;
        }

        .color-button.is-selected {
            transform: translateY(-6px);
            box-shadow: 0 35px 55px -32px rgba(14, 165, 233, .6);
            outline: 3px solid rgba(45, 212, 191, .65);
            outline-offset: 4px;
        }

        .color-button.option-reveal {
            opacity: 0;
            transform: translateY(24px) scale(.98);
        }

        .color-button.option-visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .color-button .code {
            font-size: .8rem;
            letter-spacing: .15em;
            text-transform: uppercase;
            opacity: .8;
        }

        .color-button .label {
            font-size: 1.3rem;
            letter-spacing: .02em;
        }

        .color-button .flavor {
            font-size: .85rem;
            font-weight: 500;
            opacity: .9;
        }

        .color-button.is-light {
            color: #111827;
        }

        .color-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 30px 40px -25px rgba(15, 23, 42, .85);
        }

        .color-button:focus-visible {
            outline: 3px solid rgba(59, 130, 246, .65);
            outline-offset: 4px;
        }

        .color-button:active {
            transform: translateY(-1px);
        }

        body.modal-open {
            overflow: hidden;
        }

        .confirm-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(16px, 5vw, 48px);
            background: rgba(15, 23, 42, .55);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
            z-index: 50;
        }

        .confirm-modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-panel {
            width: min(420px, 100%);
            background: linear-gradient(180deg, #fff, #fef9c3);
            border: 2px solid rgba(113, 63, 18, .25);
            border-radius: 28px;
            box-shadow: 0 40px 80px -45px rgba(15, 23, 42, .75);
            padding: clamp(20px, 4vw, 32px);
            position: relative;
        }

        .modal-eyebrow {
            text-transform: uppercase;
            font-size: .75rem;
            letter-spacing: .35em;
            color: #65a30d;
            margin-bottom: .45rem;
        }

        .modal-heading h3 {
            margin: 0;
            font-size: clamp(1.5rem, 4vw, 2rem);
            color: #14532d;
        }

        .modal-flavor {
            margin: .4rem 0 0;
            color: #4b5563;
            font-weight: 500;
        }

        .modal-selection {
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 22px;
            border: 1px dashed rgba(14, 116, 144, .4);
            background: rgba(219, 234, 254, .5);
        }

        .modal-swatch {
            width: 64px;
            height: 64px;
            border-radius: 999px;
            border: 4px solid #fefce8;
            box-shadow: 0 8px 18px rgba(15, 23, 42, .3);
            display: inline-block;
        }

        .modal-message {
            margin: 0;
            font-size: 1rem;
            color: #1f2937;
            font-weight: 600;
        }

        .modal-actions {
            margin-top: 1.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .modal-btn {
            flex: 1 1 160px;
            border-radius: 18px;
            padding: .85rem 1.2rem;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: transform .2s ease, box-shadow .2s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #16a34a, #4ade80);
            color: #fff;
            box-shadow: 0 15px 30px -20px rgba(22, 163, 74, .7);
        }

        .modal-btn.secondary {
            background: #fff;
            color: #1f2937;
            border: 1px solid rgba(15, 23, 42, .15);
        }

        .modal-btn:hover {
            transform: translateY(-3px);
        }

        .booth-scene {
            position: relative;
            /* padding: clamp(16px, 4vw, 48px); */
            display: flex;
            justify-content: center;
        }

        .booth-frame {
            width: min(1200px, 100%);
            background: rgba(255, 255, 255, .92);
            /* border-radius: 42px 42px 28px 28px; */
            /* border: 6px solid #d9f99d; */
            /* box-shadow: 0 35px 85px -45px rgba(15, 23, 42, .75); */
            overflow: hidden;
            position: relative;
        }

        .booth-arch {
            text-align: center;
            padding: 30px 10px;
            background: linear-gradient(160deg, rgba(255, 255, 255, .95), rgba(255, 255, 255, .7)), linear-gradient(60deg, #fefce8, #dcfce7);
            /* border-bottom: 1px solid rgba(15, 23, 42, .05); */
        }

        .arch-eyebrow {
            text-transform: uppercase;
            font-weight: 800;
            font-size: .85rem;
            letter-spacing: .3em;
            color: #65a30d;
            margin-bottom: .4rem;
        }

        .booth-arch h1 {
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 800;
            color: #14532d;
            margin: 0;
        }

        .arch-note {
            margin-top: .75rem;
            color: #4b5563;
            max-width: 640px;
            margin-inline: auto;
        }

        .arch-strips {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 12px;
        }

        .arch-segment {
            min-width: 75px;
            padding: .75rem .5rem;
            border-radius: 999px;
            text-align: center;
            text-transform: uppercase;
            font-size: .75rem;
            letter-spacing: .1em;
            font-weight: 700;
            color: #fff;
            background: var(--seg-color);
            box-shadow: inset 0 -4px 0 rgba(0, 0, 0, .15);
        }

        .arch-segment .seg-code {
            display: block;
            font-size: .5rem;
            letter-spacing: .25em;
        }

        .arch-segment .seg-name {
            display: block;
            font-size: .7rem;
            letter-spacing: .05em;
            margin-top: .2rem;
        }

        .booth-body {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            padding: 30px 10px;
            background: linear-gradient(90deg, rgba(255, 255, 255, .95), rgba(250, 250, 249, .9));
        }

        .shelf-panel {
            flex: 1 1 260px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .95), rgba(255, 249, 219, .8));
            border: 2px solid rgba(113, 63, 18, .15);
            border-radius: 28px;
            padding: 24px 10px;
            position: relative;
            box-shadow: inset 0 10px 30px rgba(250, 204, 21, .2);
        }

        /* .shelf-panel::before,
        .shelf-panel::after {
            content: '';
            position: absolute;
            left: 16px;
            right: 16px;
            height: 6px;
            background: rgba(113, 63, 18, .2);
            border-radius: 999px;
        } 
            .shelf-panel::before {
            top: 38%;
        }

        .shelf-panel::after {
            top: 66%;
        } */

        .shelf-panel h3 {
            font-size: 1.35rem;
            font-weight: 800;
            color: #78350f;
            margin-bottom: .25rem;
        }

        .shelf-panel p {
            color: #92400e;
            font-weight: 500;
            margin-bottom: 1.25rem;
        }

        .shelf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            position: relative;
        }

        .shelf-juice {
            background: #FCFDFD;
            border-radius: 18px;
            padding: .8rem .7rem;
            border: 2px solid rgba(113, 63, 18, .08);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: .35rem;
            box-shadow: 0 12px 18px -12px rgba(15, 23, 42, .35);
        }

        .shelf-juice img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            /* filter: drop-shadow(0 6px 8px rgba(0, 0, 0, .2)); */
        }

        .shelf-code {
            font-size: .7rem;
            letter-spacing: .2em;
            color: rgba(15, 23, 42, .5);
        }

        .shelf-label {
            font-weight: 700;
            font-size: 1rem;
            color: var(--juice-color, #14532d);
            text-align: center;
        }

        .shelf-flavor {
            font-size: .75rem;
            color: rgba(15, 23, 42, .55);
            text-align: center;
        }

        .booth-container {
            flex: 2 1 420px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .98), rgba(240, 249, 244, .95));
            border: 1px solid rgba(15, 23, 42, .08);
            border-radius: 32px;
            box-shadow: 0 25px 45px -30px rgba(15, 23, 42, .55);
            width: 100%;
        }

        .counter-wrap {
            padding: 0 clamp(16px, 4vw, 48px) clamp(24px, 5vw, 48px);
        }

        .counter-top {
            position: relative;
            background: linear-gradient(90deg, #fef3c7, #fef9c3);
            border-radius: 24px 24px 0 0;
            padding: 18px 24px;
            border: 2px solid rgba(113, 63, 18, .2);
            border-bottom: none;
            text-align: center;
            font-weight: 700;
            color: #713f12;
            text-transform: uppercase;
            letter-spacing: .1em;
        }

        .counter-top::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            box-shadow: inset 0 8px 18px rgba(255, 255, 255, .5);
            pointer-events: none;
        }

        .counter-front {
            background: linear-gradient(180deg, #fef3c7, #fde68a);
            border-radius: 0 0 32px 32px;
            border: 2px solid rgba(113, 63, 18, .25);
            border-top: none;
            padding: 20px 28px 28px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .counter-panel {
            height: 46px;
            width: 100%;
            max-width: 160px;
            border-radius: 16px;
            background: repeating-linear-gradient(135deg, rgba(113, 63, 18, .2), rgba(113, 63, 18, .2) 10px, rgba(250, 250, 249, .2) 10px, rgba(250, 250, 249, .2) 20px);
            border: 1px solid rgba(113, 63, 18, .25);
        }

        @media (max-width: 960px) {
            .booth-body {
                flex-direction: column;
            }

            .shelf-panel,
            .booth-container {
                flex-basis: auto;
            }

            .counter-front {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Uniform modern gauge (numbers removed) */
        .gauge-card {
            background: linear-gradient(180deg, rgba(0, 0, 0, .02), rgba(0, 0, 0, .01));
            border: 1px solid rgba(0, 0, 0, .05);
            border-radius: 16px;
            padding: 16px;
        }

        .gauge {
            position: relative;
            aspect-ratio: 2 / 1;
            width: 100%;
        }

        .g-needle {
            transform-origin: 50% 80%;
            transition: transform 900ms cubic-bezier(.23, 1, .32, 1);
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, .25));
        }

        .g-needle-shaft {
            fill: #1f2937;
        }

        .g-needle-cap {
            fill: #9ca3af;
        }

        .g-readout {
            position: absolute;
            left: 50%;
            bottom: 9%;
            translate: -50% 0;
            text-align: center;
        }

        .g-band {
            font-size: clamp(12px, 1.7vw, 14px);
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 1.6px;
        }

        .g-legend {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .g-legend .item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
            font-size: 12px;
        }

        .g-legend .sw {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, .2);
        }

    </style>
</head>

<body>
    <div class="booth-scene">
        <div class="booth-frame">
            <div class="booth-arch">
                <p class="arch-eyebrow">Credit Score Juice Booth</p>
                <h1>Scan • Guess • Sip the Color!</h1>
                <p class="arch-note">Scan the QR code, read the payment behavior, then match it to the correct credit
                    score color to earn your mini juice shot.</p>
                <div id="score-arch" class="arch-strips"></div>
            </div>
            <div class="booth-body">
                <aside class="shelf-panel">
                    <h3>Rewards Shelf</h3>
                    <p>Five score bands. Five fresh shots. Guess right to taste one.</p>
                    <div id="color-shelf" class="shelf-grid"></div>
                </aside>

                <div id="app-container" class="booth-container p-6 md:p-8">
                    <!-- Header -->
                    <header class="text-center mb-6">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800">Credit Score Challenge</h2>
                        <p class="text-lg text-green-600 font-semibold mt-1">Guess Your Color, Claim Your Shot!</p>
                    </header>

                    <!-- Uniform Gauge (numbers removed) -->
                    <section class="gauge-card mb-8">
                        <div id="creditGauge" class="gauge" aria-label="Credit score band" role="img"></div>
                        <div id="gLegend" class="g-legend"></div>
                    </section>

                    <!-- 1. Question Screen -->
                    <div id="question-screen" class="space-y-6">
                        <div class="p-4 bg-green-50 rounded-xl shadow-inner text-center">
                            <h4 class="text-xl font-bold text-green-800 mb-2">The Credit Behavior Scenario:</h4>
                            <p id="question-text" class="text-2xl font-semibold text-gray-800">Loading Question...</p>
                        </div>
                        <h5 class="text-center text-gray-600 font-medium">What Credit Score Color is this?</h5>
                        <p class="text-center text-sm text-gray-500">Tap a color card below to lock in your guess.</p>
                        <div id="answer-options" class="answer-options"></div>
                    </div>

                    <!-- 2. Result Screen -->
                    <div id="result-screen" class="hidden text-center space-y-6">
                        <div id="result-banner" class="p-4 rounded-xl shadow-lg">
                            <p id="result-text" class="text-2xl font-bold"></p>
                        </div>
                        <div class="p-4 rounded-xl bg-gray-50 border-l-4 border-gray-300">
                            <p class="text-lg font-semibold text-gray-600">The Correct Color Is:</p>
                            <div id="correct-color-box" class="mt-2 inline-block p-3 rounded-lg shadow-md">
                                <p id="correct-color-en" class="text-3xl font-extrabold text-white"></p>
                                <p id="correct-color-ar" class="text-xl font-medium text-white"></p>
                            </div>
                        </div>
                        <div id="description-box" class="p-4 rounded-xl shadow-md border-t-2 border-gray-200">
                            <p class="text-lg font-semibold text-gray-700 mb-2">Why This Color?</p>
                            <p id="description-en" class="text-gray-800"></p>
                            <p id="description-ar" class="text-gray-600 text-sm mt-1"></p>
                        </div>
                        <div class="p-6 rounded-xl bg-amber-50 shadow-inner border border-amber-200">
                            <h3 class="text-2xl font-bold text-amber-700 flex items-center justify-center mb-3">
                                <i data-lucide="award" class="w-6 h-6 mr-2"></i> Your Reward!
                            </h3>
                            <img id="juice-image" src="" alt="Juice Shot Reward"
                                class="mx-auto my-3 rounded-lg shadow-lg" />
                            <p id="juice-flavor" class="text-xl font-semibold text-gray-800"></p>
                            <p class="mt-4 text-green-700 font-extrabold text-lg p-2 bg-green-200 rounded-lg">Show this
                                screen to the counter staff to claim your free shot!</p>
                        </div>
                        <button id="restart-button"
                            class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-150">Try
                            Another Challenge</button>
                    </div>
                </div>
            </div>
            <!-- <div class="counter-wrap">
                <div class="counter-top">
                    <p>Serving Counter · Show your winning color to sip!</p>
                </div>
                <div class="counter-front">
                    <div class="counter-panel"></div>
                    <div class="counter-panel"></div>
                    <div class="counter-panel"></div>
                </div>
            </div> -->
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="confirm-modal" aria-hidden="true">
        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modal-color-name">
            <div class="modal-heading">
                <p class="modal-eyebrow">Confirm Your Shot</p>
                <h3 id="modal-color-name">Select a color</h3>
                <p id="modal-flavor" class="modal-flavor">Choose the flavor that fits the score.</p>
            </div>
            <div class="modal-selection">
                <span id="modal-color-swatch" class="modal-swatch" aria-hidden="true"></span>
                <p id="modal-message" class="modal-message">Ready to lock in this credit score color?</p>
            </div>
            <div class="modal-actions">
                <button id="modal-cancel" type="button" class="modal-btn secondary">Cancel</button>
                <button id="modal-confirm" type="button" class="modal-btn primary">Confirm Guess</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const IMAGE_BASE = 'img';

        // --- MOCK BACKEND DATA ---
        const colorLookup = {
            PURPLE: { hex: '#6D3DBA', en: 'Elite', ar: 'ممتاز', flavor: 'Blackberry', descEN: 'You have an excellent credit score. Negligible chance of loan failure.', descAR: 'لديك تصنيف ائتماني ممتاز مما يعني أن احتمالية تعثرك منخفضة جدًا.' },
            BLUE: { hex: '#2E86DE', en: 'Ultimate', ar: 'جيد جدًا', flavor: 'Blueberry', descEN: 'You have a good credit score. You rarely miss payments.', descAR: 'لديك تصنيف ائتماني جيد جدًا مما يعني أنك نادرًا ما تتخلف عن السداد.' },
            GREEN: { hex: '#2ECC71', en: 'Prime', ar: 'جيد', flavor: 'Apple & Cucumber', descEN: 'You have an average credit score. You have failed a few times on repayments.', descAR: 'لديك تصنيف ائتماني جيد مما يعني أنك تخلفت عن السداد في بعض الأحيان.' },
            YELLOW: { hex: '#F1C40F', en: 'Severe', ar: 'صعب', flavor: 'Lemon & Ginger', descEN: 'You have a below-average credit score. You have failed multiple times.', descAR: 'لديك تصنيف ائتماني صعب مما يعني أنك تخلفت عن السداد عدة مرات.' },
            RED: { hex: '#E74C3C', en: 'Risk', ar: 'مخاطرة', flavor: 'Beetroot', descEN: 'You have a poor credit score. High chances of rejection.', descAR: 'لديك تصنيف ائتماني ضعيف مع احتمالية عالية لرفض طلباتك الائتمانية.' }
        };

        const colorImages = {
            PURPLE: '01-blackberry.png',
            BLUE: '02-blueberry.png',
            GREEN: '03-apple-cucumber.png',
            YELLOW: '04-lemon-ginger.png',
            RED: '05-beetroot.png',
        };

        const colorOrder = ['PURPLE', 'BLUE', 'GREEN', 'YELLOW', 'RED'];

        const initialQuestions = [
            { id: 1, text: 'You always pay loans on time and never miss payments.', answer: 'PURPLE' },
            { id: 2, text: 'You missed one payment this year but usually pay on time.', answer: 'BLUE' },
            { id: 3, text: 'You occasionally delay your loan payments.', answer: 'GREEN' },
            { id: 4, text: 'You have multiple delayed payments and reminders.', answer: 'YELLOW' },
            { id: 5, text: "Your loan payment was delayed; it's now legal, and you have also missed your credit card payments.", answer: 'RED' }
        ];

        // --- APPLICATION STATE ---
        let availableQuestions = [...initialQuestions];
        let currentQuestion = null;

        // --- DOM ELEMENTS ---
        const $questionScreen = document.getElementById('question-screen');
        const $resultScreen = document.getElementById('result-screen');
        const $questionText = document.getElementById('question-text');
        const $answerOptions = document.getElementById('answer-options');
        const $colorShelf = document.getElementById('color-shelf');
        const $scoreArch = document.getElementById('score-arch');
        const $resultBanner = document.getElementById('result-banner');
        const $resultText = document.getElementById('result-text');
        const $correctColorBox = document.getElementById('correct-color-box');
        const $correctColorEn = document.getElementById('correct-color-en');
        const $correctColorAr = document.getElementById('correct-color-ar');
        const $descriptionEn = document.getElementById('description-en');
        const $descriptionAr = document.getElementById('description-ar');
        const $juiceFlavor = document.getElementById('juice-flavor');
        const $juiceImage = document.getElementById('juice-image');
        const $restartButton = document.getElementById('restart-button');
        const $confirmModal = document.getElementById('confirm-modal');
        const $modalColorName = document.getElementById('modal-color-name');
        const $modalFlavor = document.getElementById('modal-flavor');
        const $modalSwatch = document.getElementById('modal-color-swatch');
        const $modalMessage = document.getElementById('modal-message');
        const $modalCancel = document.getElementById('modal-cancel');
        const $modalConfirm = document.getElementById('modal-confirm');

        const supportsIntersectionObserver = typeof window !== 'undefined' && 'IntersectionObserver' in window;
        const optionObserver = supportsIntersectionObserver
            ? new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('option-visible');
                        entry.target.classList.remove('option-reveal');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.45 })
            : null;

        function revealOptionOnScroll(el) {
            if (!el) return;
            el.classList.add('option-reveal');
            if (optionObserver) {
                optionObserver.observe(el);
            } else {
                const show = () => el.classList.add('option-visible');
                if (typeof requestAnimationFrame === 'function') {
                    requestAnimationFrame(show);
                } else {
                    setTimeout(show, 0);
                }
            }
        }

        // --- UNIFORM GAUGE CONFIG ---
        const CONFIG = {
            min: 300,
            max: 900,
            // Equal-sized segments across the range
            segments: [
                { key: 'RED', name: 'Risk', color: '#E74C3C' },
                { key: 'YELLOW', name: 'Severe', color: '#F1C40F' },
                { key: 'GREEN', name: 'Prime', color: '#2ECC71' },
                { key: 'BLUE', name: 'Ultimate', color: '#2E86DE' },
                { key: 'PURPLE', name: 'Elite', color: '#6D3DBA' },
            ],
        };

        const SEG_SIZE = (CONFIG.max - CONFIG.min) / CONFIG.segments.length; // 120 with 300–900

        let gaugeCurrentScore = (CONFIG.min + CONFIG.max) / 2;
        let gaugeWiggleActive = false;
        const optionButtons = new Map();
        let selectedOptionKey = null;
        let pendingAnswerKey = null;

        // Compute segment boundaries uniformly
        function segBounds(index) {
            const start = CONFIG.min + index * SEG_SIZE;
            const end = index === CONFIG.segments.length - 1 ? CONFIG.max : start + SEG_SIZE;
            return { start, end };
        }

        function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

        // Gauge builder (no numeric labels)
        function buildGauge(el) {
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', '0 0 1000 500');

            // Track
            const bg = document.createElementNS(svgNS, 'path');
            bg.setAttribute('d', describeArc(500, 480, 420, 180, 0));
            bg.setAttribute('fill', 'none'); bg.setAttribute('stroke', 'rgba(0,0,0,.08)'); bg.setAttribute('stroke-width', '32');
            svg.appendChild(bg);

            // Uniform segments
            CONFIG.segments.forEach((seg, i) => {
                const { start, end } = segBounds(i);
                seg.start = start; seg.end = end; // persist computed bounds
                const startAng = mapValueToAngle(start);
                const endAng = mapValueToAngle(end);
                const path = document.createElementNS(svgNS, 'path');
                path.setAttribute('d', describeArc(500, 480, 420, startAng, endAng));
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke', seg.color);
                path.setAttribute('stroke-width', '32');
                path.setAttribute('stroke-linecap', 'round');
                svg.appendChild(path);
            });

            // Ticks (no numbers)
            const ticks = document.createElementNS(svgNS, 'g');
            ticks.setAttribute('opacity', '0.5');
            for (let i = 0; i <= 10; i++) {
                const v = CONFIG.min + (i / 10) * (CONFIG.max - CONFIG.min);
                const a = mapValueToAngle(v) * Math.PI / 180; const r1 = 380, r2 = 405;
                const x1 = 500 + r1 * Math.cos(Math.PI - a); const y1 = 480 - r1 * Math.sin(Math.PI - a);
                const x2 = 500 + r2 * Math.cos(Math.PI - a); const y2 = 480 - r2 * Math.sin(Math.PI - a);
                const t = document.createElementNS(svgNS, 'line');
                t.setAttribute('x1', x1); t.setAttribute('y1', y1); t.setAttribute('x2', x2); t.setAttribute('y2', y2);
                t.setAttribute('stroke', 'rgba(0,0,0,.22)'); t.setAttribute('stroke-width', i % 5 === 0 ? '3' : '1.5');
                ticks.appendChild(t);
            }
            svg.appendChild(ticks);

            // Needle
            const needle = document.createElementNS(svgNS, 'g');
            needle.setAttribute('id', 'needle'); needle.setAttribute('class', 'g-needle');
            needle.setAttribute('transform', 'rotate(-90 500 400)');
            const pointer = document.createElementNS(svgNS, 'rect');
            pointer.setAttribute('x', '498'); pointer.setAttribute('y', '160'); pointer.setAttribute('width', '4'); pointer.setAttribute('height', '250'); pointer.setAttribute('rx', '2'); pointer.setAttribute('class', 'g-needle-shaft');
            const shaft = document.createElementNS(svgNS, 'path');
            shaft.setAttribute('class', 'g-needle-shaft'); shaft.setAttribute('d', 'M500,400 L490,430 L510,430 Z');
            const cap = document.createElementNS(svgNS, 'circle'); cap.setAttribute('cx', '500'); cap.setAttribute('cy', '400'); cap.setAttribute('r', '12'); cap.setAttribute('class', 'g-needle-cap');
            needle.appendChild(pointer); needle.appendChild(shaft); needle.appendChild(cap);
            svg.appendChild(needle);

            // Band readout only
            const ro = document.createElement('div'); ro.className = 'g-readout'; ro.innerHTML = `<div class="g-band" id="bandText">—</div>`;
            el.appendChild(svg); el.appendChild(ro);

            // Legend
            const legend = document.getElementById('gLegend');
            legend.innerHTML = '';
            CONFIG.segments.forEach(seg => {
                const it = document.createElement('div'); it.className = 'item';
                it.innerHTML = `<span class="sw" style="background:${seg.color}"></span>${seg.name}`;
                legend.appendChild(it);
            });
        }

        function mapValueToAngle(value) {
            const v = clamp(value, CONFIG.min, CONFIG.max);
            const t = (v - CONFIG.min) / (CONFIG.max - CONFIG.min); // 0→1
            return 180 * (1 - t); // 180→0 left→right
        }

        function describeArc(cx, cy, r, startAngle, endAngle) {
            const start = polar(cx, cy, r, endAngle); const end = polar(cx, cy, r, startAngle);
            const largeArc = Math.abs(endAngle - startAngle) <= 180 ? 0 : 1;
            return ['M', start.x, start.y, 'A', r, r, 0, largeArc, 0, end.x, end.y].join(' ');
        }
        function polar(cx, cy, r, deg) { const a = deg * Math.PI / 180; return { x: cx + r * Math.cos(Math.PI - a), y: cy - r * Math.sin(Math.PI - a) }; }

        function findSegmentByScore(score) {
            return CONFIG.segments.find((s, i, arr) => {
                const { start, end } = segBounds(i);
                return score >= start && (i === arr.length - 1 ? score <= end : score < end);
            });
        }

        function midOfSegment(key) {
            const i = CONFIG.segments.findIndex(s => s.key === key);
            if (i < 0) return (CONFIG.min + CONFIG.max) / 2;
            const { start, end } = segBounds(i);
            return Math.round((start + end) / 2);
        }

        function setCreditScore(score, options = {}) {
            const { track = true } = options;
            const s = clamp(score, CONFIG.min, CONFIG.max);
            const angle = mapValueToAngle(s);
            const needle = document.getElementById('needle');
            const bandText = document.getElementById('bandText');
            const seg = findSegmentByScore(s);
            if (needle) { needle.style.transform = `rotate(${angle - 90}deg)`; }
            if (bandText) { bandText.textContent = seg ? seg.name.toUpperCase() : ''; }
            const host = document.getElementById('creditGauge');
            if (host) { host.setAttribute('aria-label', `Credit score band: ${seg ? seg.name : ''}`); }
            if (track) { gaugeCurrentScore = s; }
        }

        function wiggleNeedle() {
            if (gaugeWiggleActive) return;
            gaugeWiggleActive = true;
            const baseScore = gaugeCurrentScore;
            const wobble = Math.min(SEG_SIZE * 0.75, 60);
            setCreditScore(baseScore + wobble, { track: false });
            setTimeout(() => setCreditScore(baseScore - wobble / 2, { track: false }), 240);
            setTimeout(() => {
                setCreditScore(baseScore, { track: false });
                gaugeWiggleActive = false;
            }, 520);
        }

        function initGaugeScrollAnimation(targetEl) {
            if (!supportsIntersectionObserver || !targetEl) return;
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        wiggleNeedle();
                    }
                });
            }, { threshold: 0.5 });
            observer.observe(targetEl);
        }

        function getImagePathForColor(colorKey) {
            return `${IMAGE_BASE}/${colorImages[colorKey] || colorImages.GREEN}`;
        }

        function isColorLight(hex) {
            if (!hex) return false;
            const sanitized = hex.replace('#', '');
            const bigint = parseInt(sanitized, 16);
            if (Number.isNaN(bigint)) return false;
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.75;
        }

        function lightenHex(hex, amount = 0.2) {
            if (!hex) return '#ffffff';
            const sanitized = hex.replace('#', '');
            const bigint = parseInt(sanitized, 16);
            if (Number.isNaN(bigint)) return hex;
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            const mix = (channel) => Math.min(255, Math.round(channel + (255 - channel) * amount));
            const nr = mix(r).toString(16).padStart(2, '0');
            const ng = mix(g).toString(16).padStart(2, '0');
            const nb = mix(b).toString(16).padStart(2, '0');
            return `#${nr}${ng}${nb}`;
        }

        function setSelectedOption(colorKey) {
            selectedOptionKey = colorKey;
            optionButtons.forEach((btn, key) => {
                if (!btn) return;
                if (colorKey && key === colorKey) {
                    btn.classList.add('is-selected');
                } else {
                    btn.classList.remove('is-selected');
                }
            });
        }

        function showConfirmModal(colorKey) {
            const colorData = colorLookup[colorKey];
            pendingAnswerKey = colorKey;
            setSelectedOption(colorKey);
            if ($modalColorName) {
                $modalColorName.textContent = colorData ? `${colorData.en} (${colorKey})` : colorKey;
            }
            if ($modalFlavor) {
                $modalFlavor.textContent = colorData
                    ? `${colorData.flavor} shot is waiting for you.`
                    : 'Lock this shot in?';
            }
            if ($modalMessage) {
                const label = colorData ? colorData.en : colorKey;
                $modalMessage.textContent = `Ready to lock ${label} as your final answer?`;
            }
            if ($modalSwatch) {
                $modalSwatch.style.background = colorData ? colorData.hex : '#d1fae5';
            }
            if ($confirmModal) {
                $confirmModal.classList.add('open');
                $confirmModal.setAttribute('aria-hidden', 'false');
            }
            if (typeof document !== 'undefined' && document.body) {
                document.body.classList.add('modal-open');
            }
        }

        function closeConfirmModal(options = {}) {
            const { resetSelection = true } = options;
            if ($confirmModal) {
                $confirmModal.classList.remove('open');
                $confirmModal.setAttribute('aria-hidden', 'true');
            }
            if (typeof document !== 'undefined' && document.body) {
                document.body.classList.remove('modal-open');
            }
            if (resetSelection) {
                setSelectedOption(null);
            }
            pendingAnswerKey = null;
        }

        function renderAnswerButtons() {
            $answerOptions.innerHTML = '';
            optionButtons.clear();
            colorOrder.forEach(colorKey => {
                const colorData = colorLookup[colorKey];
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'color-button focus:outline-none';
                btn.style.setProperty('--swatch', colorData.hex);
                btn.style.setProperty('--swatch-soft', lightenHex(colorData.hex, 0.35));
                if (isColorLight(colorData.hex)) { btn.classList.add('is-light'); }
                btn.setAttribute('aria-label', `${colorData.en} (${colorKey})`);
                btn.dataset.color = colorKey;
                btn.innerHTML = `
                    <span class="code">${colorKey}</span>
                    <!-- <span class="label">${colorData.en}</span>
                    <span class="flavor">${colorData.flavor}</span> -->
                `;
                btn.addEventListener('click', () => showConfirmModal(colorKey));
                $answerOptions.appendChild(btn);
                optionButtons.set(colorKey, btn);
                revealOptionOnScroll(btn);
            });
            setSelectedOption(selectedOptionKey);
        }

        if ($modalCancel) {
            $modalCancel.addEventListener('click', () => closeConfirmModal());
        }

        if ($modalConfirm) {
            $modalConfirm.addEventListener('click', () => {
                if (!pendingAnswerKey) return;
                const answerKey = pendingAnswerKey;
                closeConfirmModal({ resetSelection: false });
                handleAnswer(answerKey);
                setSelectedOption(null);
            });
        }

        if ($confirmModal) {
            $confirmModal.addEventListener('click', (event) => {
                if (event.target === $confirmModal) {
                    closeConfirmModal();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && $confirmModal && $confirmModal.classList.contains('open')) {
                closeConfirmModal();
            }
        });

        function buildColorShelf() {
            if (!$colorShelf) return;
            $colorShelf.innerHTML = '';
            colorOrder.forEach(colorKey => {
                const data = colorLookup[colorKey];
                const card = document.createElement('div');
                card.className = 'shelf-juice';
                card.style.setProperty('--juice-color', data.hex);
                card.innerHTML = `
                    <img src="${getImagePathForColor(colorKey)}" alt="${data.flavor} juice bottle" />
                    <!-- <span class="shelf-code">${colorKey}</span> -->
                    <span class="shelf-label">${data.en}</span>
                    <span class="shelf-flavor">${data.flavor}</span>
                `;
                $colorShelf.appendChild(card);
            });
        }

        function renderArchSegments() {
            if (!$scoreArch) return;
            $scoreArch.innerHTML = '';
            CONFIG.segments.forEach(seg => {
                const data = colorLookup[seg.key];
                const block = document.createElement('div');
                block.className = 'arch-segment';
                block.style.setProperty('--seg-color', seg.color);
                block.innerHTML = `
                    <span class="seg-code">${seg.key}</span>
                    <span class="seg-name">${data ? data.en : seg.name}</span>
                `;
                $scoreArch.appendChild(block);
            });
        }

        // --- Quiz Logic ---
        function getRandomQuestion() {
            if (availableQuestions.length === 0) { availableQuestions = [...initialQuestions]; }
            const index = Math.floor(Math.random() * availableQuestions.length);
            currentQuestion = availableQuestions[index];
            availableQuestions.splice(index, 1);
            return currentQuestion;
        }

        function showQuestionScreen() {
            closeConfirmModal();
            $resultScreen.classList.add('hidden');
            $questionScreen.classList.remove('hidden');
            const q = getRandomQuestion();
            $questionText.textContent = q.text;

            renderAnswerButtons();

            // Reset gauge to center of Prime
            setCreditScore(midOfSegment('GREEN'));
        }

        function handleAnswer(userAnswer) {
            if (!currentQuestion) return;
            const correct = currentQuestion.answer;
            const isCorrect = userAnswer === correct;
            showResultScreen(isCorrect, correct);
        }

        function showResultScreen(isCorrect, correctAnswer) {
            $questionScreen.classList.add('hidden');
            $resultScreen.classList.remove('hidden');
            const correctData = colorLookup[correctAnswer];

            if (isCorrect) {
                $resultBanner.className = 'p-4 rounded-xl shadow-lg bg-green-100 border-l-4 border-green-500';
                $resultText.textContent = 'Nailed It! You Got the Score!';
                $resultText.classList.remove('text-red-700');
                $resultText.classList.add('text-green-700');
            } else {
                $resultBanner.className = 'p-4 rounded-xl shadow-lg bg-red-100 border-l-4 border-red-500';
                $resultText.textContent = `Good Try! The Correct Color Was ${correctAnswer}.`;
                $resultText.classList.remove('text-green-700');
                $resultText.classList.add('text-red-700');
            }

            // Correct answer details
            $correctColorBox.style.backgroundColor = correctData.hex;
            $correctColorEn.textContent = `${correctAnswer} (${correctData.en})`;
            $correctColorAr.textContent = correctData.ar;
            $descriptionEn.textContent = correctData.descEN;
            $descriptionAr.textContent = correctData.descAR;
            $juiceFlavor.textContent = `You've earned the ${correctAnswer} Shot (${correctData.flavor} flavor)!`;
            $juiceImage.src = getImagePathForColor(correctAnswer);
            $juiceImage.onerror = () => { $juiceImage.src = `${IMAGE_BASE}/2ECC71/ffffff?text=Juice+Shot`; };

            // Move gauge needle to the center of the correct band
            setCreditScore(midOfSegment(correctAnswer));
        }

        function initApp() { currentQuestion = null; showQuestionScreen(); }

        $restartButton.addEventListener('click', initApp);

        // Gauge init
        const host = document.getElementById('creditGauge');
        buildGauge(host);
        setCreditScore(midOfSegment('GREEN'));
        initGaugeScrollAnimation(host);
        window.addEventListener('load', () => {
            lucide.createIcons();
            renderArchSegments();
            buildColorShelf();
            initApp();
        });
    </script>
</body>

</html>
